services:
  postgres:
    image: postgres:16-alpine
    container_name: stranger_strings_postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-txdb}
      POSTGRES_USER: ${POSTGRES_USER:-mcp_readonly}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-your_secure_password}
    ports:
      - "${POSTGRES_HOST_PORT:-5433}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./sql/init.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ${TRANSACTIONS_FILE:-../dataset/transactions}:/dataset/transactions:ro  # Mount your transactions CSV file
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mcp_readonly} -d ${POSTGRES_DB:-txdb}"]
      interval: 5s
      timeout: 5s
      retries: 5

  data-loader:
    image: postgres:16-alpine
    container_name: stranger_strings_data_loader
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ${TRANSACTIONS_FILE:-../dataset/transactions}:/dataset/transactions:ro
      - ./sql/load_data_always.sql:/load_data.sql:ro
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD:-your_secure_password}
      FORCE_RELOAD: ${FORCE_RELOAD:-false}  # Set to 'true' to force data reload
    command: >
      sh -c "
        echo 'Waiting for database to be ready...' &&
        sleep 2 &&
        echo 'Loading transaction data...' &&
        if [ \"$$FORCE_RELOAD\" = \"true\" ]; then
          echo 'Force reload enabled - truncating existing data...' &&
          psql -h postgres -U ${POSTGRES_USER:-mcp_readonly} -d ${POSTGRES_DB:-txdb} -c 'TRUNCATE transactions;'
        fi &&
        psql -h postgres -U ${POSTGRES_USER:-mcp_readonly} -d ${POSTGRES_DB:-txdb} -f /load_data.sql &&
        echo 'Data loading complete!'
      "
    restart: "no"

  llm-client:
    build: .
    container_name: stranger_strings_llm
    stdin_open: true
    tty: true
    env_file:
      - .env
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Override DATABASE_URI to use the postgres service name
      DATABASE_URI: postgresql://${POSTGRES_USER:-mcp_readonly}:${POSTGRES_PASSWORD:-your_secure_password}@postgres:5432/${POSTGRES_DB:-txdb}

  backend-api:
    build: .
    container_name: stranger_strings_api
    command: python backend/backend_api.py
    ports:
      - "${API_HOST_PORT:-5000}:${API_CONTAINER_PORT:-5000}"
    volumes:
      - ./models:/app/models:ro
      - ./backend:/app/backend:ro
    environment:
      FLASK_ENV: ${FLASK_ENV:-development}
      FLASK_PORT: ${API_CONTAINER_PORT:-5000}
      MODEL_PATH: /app/models/lightgbm_model.pkl
      DATABASE_URI: postgresql://${POSTGRES_USER:-mcp_readonly}:${POSTGRES_PASSWORD:-your_secure_password}@postgres:5432/${POSTGRES_DB:-txdb}
    depends_on:
      postgres:
        condition: service_healthy
      data-loader:
        condition: service_completed_successfully

volumes:
  postgres_data: